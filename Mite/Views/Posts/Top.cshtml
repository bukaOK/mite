@using Mite.Enums
@{
    ViewBag.Title = "Публикации";
    ViewBag.MetaDescription = "Топ работ";
}
<script type="text/javascript" src="//vk.com/js/api/openapi.js?146"></script>
<div class="active loader-wrapper"><div class="ui active loader"></div></div>
<div class="ui stackable menu">
    <div class="item">
        <i class="filter icon"></i>
        Сначала&nbsp;
        <div class="ui inline dropdown" id="sortType">
            <div class="text">новые</div>
            <i class="dropdown icon"></i>
            <div class="menu">
                <div class="active item" data-text="новые" data-value="@((byte)SortFilter.New)">Новые</div>
                <div class="item" data-text="высший рейтинг" data-value="@((byte)SortFilter.Popular)">Высший рейтинг</div>
                <div class="item" data-text="старые" data-value="@((byte)SortFilter.Old)">Старые</div>
            </div>
        </div>
    </div>
    <div class="item">
        <i class="calendar icon"></i>
        Искать за&nbsp;
        <div class="ui inline dropdown" id="postTimeFilter">
            <div class="text">все время</div>
            <i class="dropdown icon"></i>
            <div class="menu">
                <div class="active item" data-text="все время" data-value="@((byte)PostTimeFilter.All)">Все время</div>
                <div class="item" data-text="последний месяц" data-value="@((byte)PostTimeFilter.Month)">Последний месяц</div>
                <div class="item" data-text="последнюю неделю" data-value="@((byte)PostTimeFilter.Week)">Последняя неделя</div>
                <div class="item" data-text="последний день" data-value="@((byte)PostTimeFilter.Day)">Последний день</div>
            </div>
        </div>
    </div>
    <div class="item">
        <i class="users icon"></i>
        Искать среди&nbsp;
        <div class="ui inline dropdown" id="postUserFilter">
            <div class="text">всех</div>
            <i class="dropdown icon"></i>
            <div class="menu">
                <div class="active item" data-text="всех" data-value="@((byte)PostUserFilter.All)">Все</div>
                @if (User.Identity.IsAuthenticated)
                {
                    <div class="item" data-text="моих подписок" data-value="@((byte)PostUserFilter.OnlyFollowings)">Мои подписки</div>
                }
            </div>
        </div>
    </div>
    <div class="right item">
        <div class="ui transparent icon input">
            <input type="text" placeholder="Поиск..." id="postsSearch" role="search" autofocus/>
            <i class="search link icon" onclick="SearchFilters.changeFilter()"></i>
        </div>
    </div>
</div>
<div class="ui stackable grid">
    <div class="three wide computer four wide tablet column">
        <div class="ui top-tags loading segment">
            <h3 class="ui dividing header">Теги</h3>
        </div>
        <div id="vk_groups" style="width: 100%"></div>
        <div class="ui segment">
            <h4 class="ui dividing header">Реклама</h4>
            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <!-- TopAd -->
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-7675079294669395"
                 data-ad-slot="2018290469"
                 data-ad-format="auto"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
    </div>
    <div class="thirteen wide computer twelve wide tablet column">
        <div class="ui posts stackable three column computer mobile only basic segment grid"></div>
        <div class="ui posts stackable two column tablet only basic segment grid"></div>
    </div>
</div>

<script id="topPostTmpl" type="text/x-jsrender">
    <div class="column">
        <div class="ui segment {{if Cover != null}}invert{{/if}}{{if !ShowAdultContent}} hide-adult-content{{/if}} post-item" id="post{{:Id}}"
             {{if Cover != null}} style="background: linear-gradient(rgba(181, 64, 198, 0.6),rgba(181, 64, 198, 0.5)), url({{:Cover}})" {{/if}}>
            <div class="extra content">
                <a href="/user/profile/{{:User.UserName}}" class="username" data-username="{{:User.UserName}}">
                    <img src="{{:User.AvatarSrc}}" class="ui avatar image" />
                    {{:User.ShowName}}
                </a>
                <div class="ui user-card flowing popup" style="width: 360px;min-height: 50px;">
                    <div class="dot-loader">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
                <span style="float: right">
                    <a class="ui compact inverted {{if Cover == null}}violet {{/if}}button" href="/posts/showpost/{{:Id}}">
                        {{if IsImage}}
                        Смотреть
                        {{else}}
                        Читать
                        {{/if}}
                    </a>
                </span>
            </div>
            <div class="ui {{if Cover != null}}inverted {{/if}}divider"></div>
            {{if IsImage}}
            <div class="img-content">
                <a href="/posts/showpost/{{:Id}}">
                    <img src="{{:Content}}" class="ui image" />
                </a>
                {{if IsGif}}
                <div class="active gif-wrapper">
                    <button class="ui large circular icon primary button" onclick="loadFullGif('{{:FullPath}}', '{{:Id}}', $(this))"><i class="fire icon"></i></button>
                    <span class="ui violet label">gif</span>
                </div>
                {{/if}}
            </div>
            {{else}}
            <a class="content" href="/posts/showpost/{{:Id}}">
                {{:Content}}
            </a>
            {{/if}}
            <div class="ui {{if Cover != null}}inverted {{/if}}divider"></div>
            <div class="extra content">
                <a class="ui {{if Cover != null}}inverted {{/if}}header" style="margin-bottom: 5px" href="/posts/showpost/{{:Id}}">
                    {{:Title}}
                    <span class="sub header">
                        {{:Description}}
                    </span>
                </a>
                {{for Tags ~Cover=Cover}}
                <a class="ui{{if ~Cover != null}} invert{{/if}} label" onclick="loadTag('#{{>#data}}')">{{>#data}}</a>
                {{/for}}
            </div>
            <div class="ui {{if Cover != null}}inverted {{/if}} divider"></div>
            <div class="extra content">
                <span>{{:PublicTimeStr}}</span>
                <div class="right floated" style="float: right">
                    <i class="yellow star icon"></i>{{:Rating}}
                    <i class="{{if Cover == null}}blue{{else}}black{{/if}} unhide icon"></i>{{:Views}}
                    <i class="green comments outline icon"></i>{{:CommentsCount}}
                </div>
            </div>
            {{if !ShowAdultContent}}
            <div class="ui dimmer">
                <div class="content">
                    <div class="center">
                        <h2 class="ui inverted header">Взрослый контент(18+)</h2>
                        <button class="ui primary button" onclick="$(this).parents('.post-item').dimmer('hide')">Показать</button>
                    </div>
                </div>
            </div>
            {{/if}}
        </div>
    </div>
</script>
<script id="miniUserCardTmpl" type="text/x-jsrender">
    <div class="ui grid">
        <div class="five wide column">
            <img class="ui tiny circular image" src="{{:AvatarSrc}}" />
        </div>
        <div class="user-info eleven wide column">
            <div class="ui grid">
                <div class="row">
                    <div class="column">
                        <a href="/user/profile/{{:UserName}}">
                            <h3 class="ui blue header">
                                {{:UserName}}
                                <span class="sub header">{{:About}}</span>
                            </h3>
                        </a>
                    </div>
                </div>
                <div class="statistics row">
                    <div class="six wide column">
                        <div class="ui mini statistic">
                            <div class="value">{{:FollowersCount}}</div>
                            <div class="label">{{:FollowersWord}}</div>
                        </div>
                    </div>
                    <div class="five wide column">
                        <div class="ui mini statistic">
                            <div class="value">{{:Rating}}</div>
                            <div class="label">Рейтинг</div>
                        </div>
                    </div>
                    <div class="five wide column">
                        <div class="ui mini statistic">
                            <div class="value">{{:PostsCount}}</div>
                            <div class="label">{{:PostsCountWord}}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>
<template id="topTagsTmpl">
    <div class="ui column">
        <div class="ui top-tags loading segment">
            <h3 class="ui dividing header">Теги</h3>
        </div>
    </div>
</template>
<template id="emptyResultTmpl">
    <div class="column"></div>
    <div class="column">
        <h2 class="ui center aligned icon header" style="color: #6D6788; margin-top: 20px;">
            <i class="frown icon"></i>
            <span class="content">
                К сожалению, по вашему запросу ничего не найдено.
            </span>
        </h2>
    </div>
</template>
@Scripts.Render("~/bundles/grid")
<script>
    var tagsInitialized = false;
    var userCardTmpl = $.templates('#miniUserCardTmpl');
    function loadTag(name) {
        $('#postsSearch').val(name);
        SearchFilters.changeFilter();
    }
    function initTags() {
        $.ajax({
            url: '/api/tags',
            success: function (resp) {
                var tmpl = '<a class="ui label" onclick="loadTag(\'#{{:Name}}\')">{{:Name}}</a>';
                var html = $.templates(tmpl).render(resp);
                $('.top-tags').append(html);
                $('.top-tags').removeClass('loading');
            },
            error: function (jqXhr) {
                alert('Ошибка при загрузке тегов');
            }
        });
    }
    function loadFullGif(newPath, postId, $button) {
        $button.addClass('loading');

        var postSelector = '#post' + postId;
        var $img = $(postSelector + ' .img-content .image');
        $img.attr('src', newPath);
        $img.on('load', function () {
            $(postSelector + ' .gif-wrapper').removeClass('active');
            $button.removeClass('loading');
        });
    }
    $(function () {
        initTags();
        var grid = $('.posts.grid:visible').masonry({
            itemSelector: '.column'
        });
        $('.ui.dropdown').dropdown({
            onChange: function (ev) {
                console.log(ev);
                if (SearchFilters.initialized) {
                    SearchFilters.changeFilter();
                }
            }
        });
        $('#postsSearch').keydown(function (ev) {
            if (ev.which == 13) {
                SearchFilters.changeFilter();
            }
        })
        SearchFilters.init({
            beforeLoad: function () {
                $('.loader-wrapper').addClass('active');
            },
            onSuccess: function (resp) {
                if (resp.status == null || resp.status == undefined) {
                    resp = JSON.parse(resp);
                }
                resp.data.forEach(function (elem) {
                    elem.PublishDate += elem.PublishDate[elem.PublishDate - 1] == 'Z' ? '' : 'Z';
                    elem.PublicTimeStr = ViewHelper.getPastTense(new Date(elem.PublishDate).getTime());
                    if (elem.User.UserName.length <= 16) {
                        elem.User.ShowName = elem.User.UserName;
                    } else {
                        elem.User.ShowName = elem.User.UserName.substr(0, 16) + '...';
                    }
                });
                $('.posts.grid:visible .loader').remove();
                if (resp.data.length > 0) {
                    var tmpl = $.templates('#topPostTmpl');
                    var html = tmpl.render(resp.data);

                    if (SearchFilters._loadNextPage) {
                        grid.append(html);
                    } else {
                        grid.html(html);
                    }
                }
                else if (SearchFilters._page <= 1) {
                    grid.html($('#emptyResultTmpl').html());
                }
                var $dimm = $('.post-item.hide-adult-content:not(.dimmed,.dimmable)');
                $dimm.dimmer({
                    closable: false
                });
                $dimm.dimmer('show');
                grid.masonry('reloadItems')
                grid.imagesLoaded(function () {
                    $('.loader-wrapper').removeClass('active');
                }).progress(function () {
                    grid.masonry('layout');
                });
                $('a.username:not(.initialized)').popup({
                    position: 'bottom left',
                    popup: $(this).siblings('.user-card.popup')[0],
                    variation: 'basic',
                    hoverable: true,
                    inline: true,
                    transition: 'slide top',
                    preserve: true,
                    onShow: function (item) {
                        var $popup = this;
                        $.ajax({
                            url: '/userprofile/getuserprofile',
                            data: 'name=' + item.dataset.username,
                            type: 'post',
                            success: function (resp) {
                                if (resp.status == undefined) {
                                    resp = JSON.parse(resp);
                                }
                                var respData = resp.data;
                                respData.PostsCountWord = ViewHelper.getWordCase(respData.PostsCount, 'Работа', 'Работы', 'Работ');
                                respData.FollowersWord = ViewHelper.getWordCase(respData.FollowersCount, 'Подписка', 'Подписки', 'Подписок');
                                $(item).popup('change content', userCardTmpl.render(resp.data));
                                $(item).popup('reposition');
                                item.classList.add('initialized');
                            }
                        });
                    }
                });
            },
            onError: function () {
                alert('Ошибка сервера');
                $('.loader-wrapper').removeClass('active');
            },
            ajax: {
                type: 'post',
                url: '@Url.Action("Top", "Posts")',
                checkResponseLength: function (resp) {
                    if (resp.status == null || resp.status == undefined) {
                        resp = JSON.parse(resp);
                    }
                    if (resp.data.length == 0) {
                        return false;
                    }
                    return true;
                }
            },
            filters: [
                {
                    name: 'tags',
                    selector: '#postsSearch',
                    getVal: function () {
                        var arr = $(this.selector).val().split('#')
                        arr.shift();
                        return arr.join();
                    },
                    updateState: function (newVal) {
                        var arr = newVal.split(',');
                        var str = arr.length > 0 ? '#' + arr.join('#') : '';
                        $(this.selector).val(str);
                    }
                },
                {
                    name: 'postName',
                    selector: '#postsSearch',
                    getVal: function () {
                        return $(this.selector).val().split('#')[0];
                    },
                    updateState: function (newVal) {
                        $(this.selector).val(newVal);
                    }
                },
                {
                    name: 'sortFilter',
                    selector: '#sortType',
                    getVal: function () {
                        return $(this.selector).dropdown('get value') == ''
                            ? '@((byte)SortFilter.New)' : $(this.selector).dropdown('get value');
                    },
                    updateState: function (newVal) {
                        $(this.selector).dropdown('set selected', newVal);
                    }
                },
                {
                    name: 'postTimeFilter',
                    selector: '#postTimeFilter',
                    getVal: function () {
                        return $(this.selector).dropdown('get value') == ''
                            ? '0' : $(this.selector).dropdown('get value');
                    },
                    updateState: function (newVal) {
                        $(this.selector).dropdown('set selected', newVal);
                    }
                },
                {
                    name: 'postUserFilter',
                    selector: '#postUserFilter',
                    getVal: function () {
                        return $(this.selector).dropdown('get value') == ''
                            ? '0' : $(this.selector).dropdown('get value');
                    },
                    updateState: function (newVal) {
                        $(this.selector).dropdown('set selected', newVal);
                    }
                }
            ]
        });
        Scrolling.init('footer', function () {
            if (!$('.loader-wrapper').hasClass('active')) {
                return SearchFilters.loadNext();
            }
        });
        SearchFilters.loadNext();
        $('.ui.checkbox').checkbox();
        VK.Widgets.Group("vk_groups", { mode: 3, no_cover: 1, width: $('.top-tags')[0].offsetWidth }, 143219082);
    });
</script>